#!/bin/bash
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

VERSION=@version@

LIBDIR='@libdir@'
SYSCONFDIR='@sysconfdir@'

[[ -r ${LIBDIR}/util-msg.sh ]] && source ${LIBDIR}/util-msg.sh
import ${LIBDIR}/util.sh

# connect(){
#     local home="/home/frs/project/${project}"
#     echo "${ACCOUNT},${project}@frs.${file_host}:${home}"
# }

connect(){
    local home="/srv/iso/iso"
    local file_host='downloads.artixlinux.org'
    echo "${ACCOUNT}@${file_host}:${home}"
}

prepare_transfer(){
    DEST_DIR="/iso/${PROFILE}/"
    SRC_DIR="${ISO_POOL}/${PROFILE}/"
}

sync_dir(){
    msg "Start upload [%s] ..." "${PROFILE}"
    rsync "${rsync_args[@]}" ${SRC_DIR} $(connect)${DEST_DIR}
    msg "Done upload [%s]" "${PROFILE}"
    show_elapsed_time "${FUNCNAME}" "${timer_start}"
}

display_settings(){
    show_version
    show_config

    msg "OPTIONS:"
    msg2 "PROFILE: %s" "${PROFILE}"
    msg2 "UPLIMIT: %s kB/s" "${UPLIMIT}"

    msg "ARGS:"
    msg2 "update: %s" "${update}"
    msg2 "verbose: %s" "${verbose}"

    msg "REMOTE:"
    msg2 "ACCOUNT: %s" "${ACCOUNT}"

    msg "UPLOAD:"
    msg2 "SRC_DIR: ${SRC_DIR}"
    msg2 "DEST_DIR: ${DEST_DIR}"
}

load_user_info

load_config "${AT_USERCONFDIR}/artools.conf" || load_config "${SYSCONFDIR}/artools.conf"

# project='artix-linux'
# file_host='sourceforge.net'

pretend=false
update=false
verbose=false

rsync_args=(-aP --progress -e ssh)

usage() {
    echo "Usage: ${0##*/} [options]"
    echo "    -p                 Source folder to upload [default: ${PROFILE}]"
    echo "    -l                 Limit bandwidth in kB/s [default:${UPLIMIT}]"
    echo '    -u                 Update remote directory'
    echo '    -q                 Query settings and pretend upload'
    echo '    -v                 Verbose output'
    echo '    -h                 This help'
    echo ''
    echo ''
    exit $1
}

opts='p:l:uvqh'

while getopts "${opts}" arg; do
    case "${arg}" in
        p) PROFILE="$OPTARG" ;;
        l) UPLIMIT="$OPTARG" ;;
        u) update=true; rsync_args+=(-u) ;;
        v) verbose=true; rsync_args+=(-v --stats) ;;
        q) pretend=true; rsync_args+=(-n) ;;
        h|?) usage 0 ;;
        *) echo "invalid argument '${arg}'"; usage 1 ;;
    esac
done

shift $(($OPTIND - 1))

timer_start=$(get_timer)

rsync_args+=(--bwlimit=${UPLIMIT})

prepare_transfer

${pretend} && display_settings #&& exit 1

sync_dir
