#!/bin/bash
#
# Copyright (C) 2018-19 artoo@artixlinux.org
# Copyright (C) 2018 Artix Linux Developers
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

. @libdir@/artools/util-pkg.sh

prepare_artools

get_pkgbasename(){
    local pkg="$1"
    local pkgbasename name ver rel arch

    pkgbasename=${pkg%.pkg.tar*}
    arch=${pkgbasename##*-}
    pkgbasename=${pkgbasename%-"$arch"}

    rel=${pkgbasename##*-}
    pkgbasename=${pkgbasename%-"$rel"}

    ver=${pkgbasename##*-}

    name=${pkgbasename%-"$ver"}
    echo $name
}

add(){
    packages+=("$pkg")
    if [[ -e "${pkgfile}" ]]; then
        action='add'
        ln -sf "${pkgfile}"{,.sig} "$repo_path"/
    fi
}

remove(){
    packages+=("$(get_pkgbasename "$pkg")")
    if [[ -e "$repo_path"/"$pkg" ]]; then
        action='remove'
        rm "$repo_path"/"$pkg"
    fi
    [[ -e "$repo_path"/"$pkg".sig ]] && rm "$repo_path"/"$pkg".sig
}

repo_action(){
    local packages=() action= func="$1"
    for pkg in ${passfiles[@]}; do
        if pkgfile=$(find_cached_pkgfile "$pkg");then
            msg "Found: %s" "${pkgfile}"
            "$func"
        fi
    done
    cd $repo_path
    if [[ -n "$action" ]]; then
        repo-"$action" -R "${dest_repo}"."${PKGDBEXT}" "${packages[@]}"
        ${linksdb} && links-"$action" "${dest_repo}"."${LINKSDBEXT}" "${packages[@]}"
    fi
}

load_makepkg_config

add_pkg=false
rm_pkg=false
linksdb=false

cmd=${0##*/}
dest_repo=${cmd#*-}

usage() {
    echo "Usage: ${cmd} [options]"
    echo '    -d <dest>          Destination repository'
    echo '    -a                 Add package(s) to repository'
    echo '    -r                 Remove package(s) from repository'
    echo '    -l                 Use links db'
    echo '    -h                 This help'
    echo ''
    echo ''
    exit $1
}

opts='arlhd:'

while getopts "${opts}" arg; do
    case "${arg}" in
        d) dest_repo="$OPTARG" ;;
        a) add_pkg=true; rm_pkg=false ;;
        r) rm_pkg=true; add_pkg=false ;;
        l) linksdb=true ;;
        h|?) usage 0 ;;
        *) echo "invalid argument '${arg}'"; usage 1 ;;
    esac
done

shift $(($OPTIND - 1))

passfiles="$@"

prepare_dir "${REPOS_ROOT}"

repo_path=${REPOS_ROOT}/${dest_repo}/os/${ARCH}

if [[ -n ${passfiles[@]} ]]; then
    if ${add_pkg}; then
        repo_action add
    fi
    if ${rm_pkg}; then
        repo_action remove
    fi
fi
