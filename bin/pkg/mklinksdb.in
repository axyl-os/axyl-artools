#!/bin/bash
#
# Copyright (C) 2018-19 artoo@artixlinux.org
# Copyright (C) 2019 Artix Linux Developers
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

. @libdir@/artools/util-base.sh
. @libdir@/artools/util-pkg.sh

load_user_info

load_config "${USERCONFDIR}/artools/artools.conf" || load_config "${SYSCONFDIR}/artools.conf"

target="${REPOS_ROOT}"

# arches=('x86_64')
lock='/tmp/links.lck'
tmp="$(mktemp -d)"

[ -f "${lock}" ] && exit 1
touch "${lock}"

renice +10 -p $$ > /dev/null

getpkgname() {
    local tmp

    tmp=${1##*/}
    echo ${tmp%-*.pkg.tar.*}
}

add_pkg_links(){
# for repo in ${REPO_NAMES[@]}; do
#     for arch in ${arches[@]}; do
    local repo="$1" pkg="$1"

        repodir=${repo}/os/${ARCH}
        [ ! -f ${REPOS_ROOT}/$repodir/$repo.db ] && continue
        msg "$repo/$ARCH..."
        mkdir -p ${tmp}/tmp/${repodir}

        # extract old file archive
        if [ -f ${REPOS_ROOT}/${repodir}/${repo}.links.tar.gz ]; then
            mkdir -p ${tmp}/cache/${repodir}
            bsdtar -xf ${REPOS_ROOT}/${repodir}/${repo}.links.tar.gz -C ${tmp}/cache/${repodir}
        fi

        # create file lists
#         for pkg in $(find ${REPOS_ROOT}/$repodir -xtype f -name "*-${ARCH}.pkg.tar.*"); do
            pkgname=$(getpkgname $pkg)
            tmppkgdir=${tmp}/tmp/${repodir}/${pkgname}
            mkdir -p $tmppkgdir
            if [ -f "${tmp}/cache/${repodir}/${pkgname}/links" ]; then
                # reuse the cached file
                mv ${tmp}/cache/${repodir}/${pkgname}/links ${tmppkgdir}/links
            else
                msg "$repo/$ARCH: $pkgname"
                mkdir -p ${tmppkgdir}/pkg
                bsdtar -xof $pkg -C ${tmppkgdir}/pkg --include={opt,{,usr/}{lib{,32},{s,}bin}}'/*' 2>/dev/null
                for f in $(find ${tmppkgdir}/pkg -type f); do
                    readelf -d "$f" 2> /dev/null | sed -nr 's/.*Shared library: \[(.*)\].*/\1/p'
                done | sort -u > ${tmppkgdir}/links
                rm -rf ${tmppkgdir}/pkg
            fi
#         done

        # create new file archive
        pkgdir=${REPOS_ROOT}/${repodir}
        mkdir -p $pkgdir
        bsdtar --exclude=*.tar.* -czf ${pkgdir}/${repo}.links.tar.gz -C ${tmp}/tmp/${repodir} .
#     done
# done

    rm -rf ${tmp}
    rm -f "${lock}"

}

