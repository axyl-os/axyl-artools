#!/bin/bash
#
# Copyright (C) 2018-19 artoo@artixlinux.org
# Copyright (C) 2018 Artix Linux Developers
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

. @libdir@/artools/util-pkg.sh

prepare_artools

get_path(){
    local repo="$1" pkg=trunk/PKGBUILD
    if [[ $repo != trunk ]]; then
        [[ -f repos/$repo-${ARCH}/PKGBUILD ]] && pkg=repos/$repo-${ARCH}/PKGBUILD
        [[ -f repos/$repo-any/PKGBUILD ]] && pkg=repos/$repo-any/PKGBUILD
    fi
    echo $pkg
}

prepare_commit(){
    local dest="$1" to_rm="${2:-none}"
    [[ -d repos/$to_rm ]] && git rm -r repos/$to_rm
    [[ -d repos/$dest ]] && git rm -r repos/$dest
    [[ ! -d repos ]] && mkdir repos
    [[ ! -d repos/$dest ]] && mkdir repos/$dest
}

check_team(){
    if [[ ${REPO_SRC} == "core" && ${REPO_DEST} == "extra" ]] || \
        [[ ${REPO_SRC} == "extra" && ${REPO_DEST} == "core" ]] || \
        [[ ${REPO_SRC} == "extra" && ${REPO_DEST} == "community" ]] || \
        [[ ${REPO_SRC} == "community" && ${REPO_DEST} == "extra" ]] ;then

        local org=$(get_pkg_org "${PACKAGE}")
        add_repo_to_team "${PACKAGE}" "$org" "${REPO_DEST}"
        remove_repo_from_team "${PACKAGE}" "$org" "${REPO_SRC}"
    fi
}

commit_pkg(){
    local artixpath=$(find_pkg "${TREE_DIR_ARTIX}" "${PACKAGE}")

    if [[ -n ${artixpath} ]];then

        local group=${artixpath%/*}

        cd ${group}

        local head=$(get_local_head)

        cd ${artixpath}

        local pkgbuild=$(get_path "${REPO_SRC}")

        . $pkgbuild
        [[ $arch == 'any' ]] && CARCH=any

        local version=$(get_full_version)

        local commit_msg=""

        if ${remove};then
            local action='remove'
            if [[ "${REPO_SRC}" == 'trunk' ]];then
                local pkg=${PACKAGE}
                git rm -r trunk
            else
                local pkg="${PACKAGE}-$version"
                git rm -r repos/"${REPO_SRC}-$CARCH"
            fi
            commit_msg="[${REPO_SRC}] '$pkg' ${action}"
            msg "Action: %s" "$commit_msg"
        else
            local action='modify'
            commit_msg="[${REPO_SRC}] '${PACKAGE}-$version' ${action}"
            msg "Action: %s" "$commit_msg"
            git add .
        fi
        git commit -m "$commit_msg"

        cd ${group}

        ${push} && pull_tree "${group##*/}" "$head"

#         subrepo_pull "${PACKAGE}"
        subrepo_push "${PACKAGE}"
        subrepo_clean "${PACKAGE}"

        ${push} && push_tree "${group##*/}"

        git prune
    else
        error "Package '%s' does not exist!" "${PACKAGE}"
    fi
}

repo_commit_pkg(){
    local artixpath=$(find_pkg "${TREE_DIR_ARTIX}" "${PACKAGE}")
    if [[ -n ${artixpath} ]];then

        local group=${artixpath%/*}

        cd ${group}

        local head=$(get_local_head)

        cd ${artixpath}

        local pkgbuild=$(get_path "${REPO_SRC}")

        . $pkgbuild
        [[ $arch == 'any' ]] && CARCH=any

        local version=$(get_full_version)

        if [[ ${REPO_SRC} == 'trunk' ]];then
            local action='add'
            local dest="${REPO_DEST}-$CARCH" rm_arch='none'
            case "$CARCH" in
                'any') rm_arch="${REPO_DEST}-x86_64" ;;
                'x86_64') rm_arch="${REPO_DEST}-any" ;;
            esac

            prepare_commit "$dest" "$rm_arch"

            cp trunk/* repos/$dest/
        else
            local action='move'
            local src="${REPO_SRC}-$CARCH" dest="${REPO_DEST}-$CARCH"

            [[ ! -f repos/$src/PKGBUILD ]] && die "%s does not exist!" "repos/$src/PKGBUILD"
            prepare_commit "$dest"

            cp repos/$src/* repos/$dest/
            git rm -r repos/$src
        fi
        local commit_msg="[${REPO_SRC}] -> [${REPO_DEST}] '${PACKAGE}-$version' ${action}"
        msg "Action: %s" "$commit_msg"

        git add .
        git commit -m "$commit_msg"

        cd ${group}

        ${push} && pull_tree "${group##*/}" "$head"

#         subrepo_pull "${PACKAGE}"
        subrepo_push "${PACKAGE}"
        subrepo_clean "${PACKAGE}"

        ${push} && push_tree "${group##*/}"

        git prune

        check_team
    else
        error "Package '%s' does not exist!" "${PACKAGE}"
    fi
}

is_valid_repo(){
    local src="$1" cases=
    set_arch_repos true true true
    for r in ${ARCH_REPOS[@]};do
        cases=${cases:-}${cases:+|}${r}
    done
    eval "case $src in
        ${cases}|trunk) return 0 ;;
        *) return 1 ;;
    esac"
}

load_makepkg_config

REPO_SRC='trunk'
PACKAGE=''
remove=false
push=false

cmd=${0##*/}
REPO_DEST=${cmd%pkg}

usage() {
    echo "Usage: ${0##*/} [options]"
    echo "    -s <name>          Source repository [default:${REPO_SRC}]"
    echo '    -p <pkg>           Package name'
    echo '    -r                 Delete from repo (commitpkg only)'
    echo '    -u                 Push'
    echo '    -h                 This help'
    echo ''
    echo ''
    exit $1
}

orig_argv=("$0" "$@")

opts='p:s:urh'

while getopts "${opts}" arg; do
    case "${arg}" in
        s) REPO_SRC="$OPTARG" ;;
        p) PACKAGE="$OPTARG" ;;
        r) remove=true ;;
        u) push=true ;;
        h|?) usage 0 ;;
        *) echo "invalid argument '${arg}'"; usage 1 ;;
    esac
done

shift $(($OPTIND - 1))

if $(is_valid_repo "${REPO_SRC}");then
    if [[ "${cmd}" == 'commitpkg' ]];then
        commit_pkg
    else
        repo_commit_pkg
    fi
else
    error "source repository '%s' is not valid!" "${REPO_SRC}"
fi
